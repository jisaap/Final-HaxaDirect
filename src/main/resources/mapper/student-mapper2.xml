<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="student2">
	
	<!-- 서브퀴리를 통해 이수구분을 받아오는 HD_SUBJECT_TB에서 과목종류 SUB_TYPE, 이수학점 COMPLETE_PT 을 조회해와야한다. -->
	<select id="selectGradeList" parameterType="string" resultMap="GradeResult">
		SELECT A.*, B.SUB_TYPE, C.PROF_NAME FROM HD_GRADE_TB A 
		JOIN (SELECT SUB_CODE, SUB_TYPE FROM HD_SUBJECT_TB) B 
		ON (A.SUB_CODE = B.SUB_CODE)
		JOIN (SELECT PROF_ID, PROF_NAME FROM HD_PROFESSOR_TB) C
		ON (A.PROF_ID = C.PROF_ID)
		WHERE STU_NO=#{stuNo}
		ORDER BY ACA_YEAR_SEM DESC, SUB_NAME ASC
	</select>
	<select id="selectGradeListSubType" parameterType="string" resultType="map">
		SELECT SUBSTR(aca_year_sem,1,4) as year,
        SUBSTR(aca_year_sem,6) as semester,
        (select DECODE(sum(rcv_credits),0,0,NULL, 0,sum(rcv_credits)) from hd_subject_tb
        join hd_grade_tb using(sub_code) 
        where sub_type='전공선택' AND hd_grade_tb.aca_year_sem=MAIN.aca_year_sem and STU_NO=#{stuNo}
        and 'A01'=SUBSTR(sub_code,1,3)) AS MAJORSELECT,
        (select DECODE(sum(rcv_credits),0,0,NULL, 0,sum(rcv_credits)) 
            from hd_subject_tb
            join hd_grade_tb using(sub_code) 
            where sub_type='전공필수' AND hd_grade_tb.aca_year_sem=MAIN.aca_year_sem and STU_NO=#{stuNo}
             and 'A01'=SUBSTR(sub_code,1,3)
            ) AS MAJORNEED,
        (select DECODE(sum(rcv_credits),0,0,NULL, 0,sum(rcv_credits)) from hd_subject_tb
        join hd_grade_tb using(sub_code) 
        where sub_type='교양선택' AND hd_grade_tb.aca_year_sem=MAIN.aca_year_sem and STU_NO=#{stuNo}
         ) AS ELECTRIVESELECT,
        (select DECODE(sum(rcv_credits),0,0,NULL, 0,sum(rcv_credits)) from hd_subject_tb
        join hd_grade_tb using(sub_code) 
        where sub_type='교양필수' AND hd_grade_tb.aca_year_sem=MAIN.aca_year_sem and STU_NO=#{stuNo}
         ) AS ELECTRIVENEED,
        (select DECODE(sum(rcv_credits),0,0,NULL, 0,sum(rcv_credits)) 
            from hd_subject_tb
            join hd_grade_tb using(sub_code) 
            where sub_type like '전공%' AND hd_grade_tb.aca_year_sem=MAIN.aca_year_sem and STU_NO=#{stuNo}
            and 'A01'!=SUBSTR(sub_code,0,3)) AS OTHER
	FROM (SELECT * from hd_grade_tb join hd_subject_tb using(sub_code)) MAIN
	GROUP BY (ACA_YEAR_SEM)
	ORDER BY 1,2
	</select>
	
	<insert id="insertRequest" parameterType="request">
		INSERT INTO HD_REQUEST_TB VALUES(#{stuNo},#{reqDate},#{reqTitle},#{reqContent},#{acaYearSem},#{profId},#{subCode},DEFAULT,NULL,#{profName})
	</insert> 
	
<!-- 	<resultMap type="reauest" id="RequestResult">
		<result column="STU_NO" property="stuNo"/>
		<result column="REQ_DATE" property="reqDate"/>
		<result column="REQ_TITLE" property="reqTitle"/>
		<result column="REQ_CONTENT" property="reqContent"/>
		<result column="ACA_YEAR_SEM" property="acaYearSem"/>
		<result column="PROF_ID" property="profId"/>
		<result column="SUB_CODE" property="subCode"/>
		<result column="REQ_YN" property="reqYn"/>
		<result column="REQ_ANSWER" property="reqAnswer"/>
		<result column="PROF_NAME" property="profName"/>
	</resultMap> -->
	
	
	<!-- resultMap에 개념은 vo객체와 DB에 있는 컬럼명이 맞지 않을경우 매칭이 안되므로 그 매칭을 해주기 위해 설정 해주는 것. -->
	<resultMap type="grade" id="GradeResult">
		<!-- typeHandler="" 은 뭐지? -->
		<result column="ACA_YEAR_SEM" property="acaYearSem"/>
		<result column="SUB_CODE" property="subCode"/>
		<result column="SUB_NAME" property="subName"/>
		<result column="PROF_ID" property="profId"/>
		<result column="MTERM" property="mterm"/>
		<result column="FTERM" property="fterm"/>
		<result column="ASSIGN_1" property="assign1"/>
		<result column="ASSIGN_2" property="assign2"/>
		<result column="ASSIGN_3" property="assign3"/>
		<result column="ASSIGN_4" property="assign4"/>
		<result column="GRADE" property="grade"/>
		<result column="STU_NO" property="stuNo"/>
		<result column="RETAKE" property="retake"/>
		<result column="RCV_CREDITS" property="rcvCredits"/>
		<result column="SUB_TYPE" property="subType"/>
		<result column="PROF_NAME" property="profName"/>
	</resultMap>
	


  
</mapper>
